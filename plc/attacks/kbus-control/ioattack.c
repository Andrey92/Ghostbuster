#include <linux/ioctl.h>

#include <fcntl.h>
#include <unistd.h>
#include <sys/ioctl.h>
#include <stdio.h>

#define DEVICE_FILE_NAME "/dev/kbus0"

typedef unsigned	__u32;
typedef char		__u8;
typedef __u32		u32;
typedef __u8		u8;


// ***************** kbus ioctl payloads *****************


/*
// 4 bytes command version

u8 tx[4] = {0x40, 0x00, 0x00, 0x00};
u8 rx[4] = {0x00, 0x00, 0x00, 0x00};

u32 tx_lens[21] = { 8, 8,12, 8, 8, 8, 8, 8,12,12,12,12,12,12,12,12,12,12,12,12,12};
u32 rx_lens[21] = {16,48,12,48,48,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16};

u8 tx1[8] = {0xa1, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 tx2[8] = {0xb0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 tx3[12] = {0xb1, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x6c, 0x05, 0x00, 0x00};
u8 tx4[8] = {0xb0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 tx5[8] = {0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 tx6[8] = {0xc1, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 tx7[8] = {0xc2, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 tx8[8] = {0xc3, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 tx9[12] = {0xc4, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00};
u8 tx10[12] = {0xc4, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x0b, 0x00, 0x00, 0x00};
u8 tx11[12] = {0xc4, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00};
u8 tx12[12] = {0xc4, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x0d, 0x00, 0x00, 0x00};
u8 tx13[12] = {0xc4, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x21, 0x00, 0x00, 0x00};
u8 tx14[12] = {0xc4, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x1e, 0x00, 0x00, 0x00};
u8 tx15[12] = {0xc4, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00};
u8 tx16[12] = {0xc4, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00};
u8 tx17[12] = {0xc4, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x22, 0x00, 0x00, 0x00};
u8 tx18[12] = {0xc4, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x00};
u8 tx19[12] = {0xc4, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00};
u8 tx20[12] = {0xc4, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x00};
u8 tx21[12] = {0xc4, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x1d, 0x00, 0x00, 0x00};

u8* cmds[21] = { tx1, tx2, tx3, tx4, tx5, tx6, tx7, tx8, tx9, tx10, tx11, tx12, tx13, tx14, tx15, tx16, tx17, tx18, tx19, tx20, tx21 };

u8 rx1[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx2[48] =
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx3[12] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx4[48] =
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx5[48] =
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx6[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx7[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx8[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx9[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx10[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx11[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx12[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx13[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx14[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx15[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx16[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx17[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx18[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx19[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx20[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx21[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

u8* resp[21] = { rx1, rx2, rx3, rx4, rx5, rx6, rx7, rx8, rx9, rx10, rx11, rx12, rx13, rx14, rx15, rx16, rx17, rx18, rx19, rx20, rx21 };
*/



// 2 bytes command version

u8 tx[2] = {0x40, 0x00};
u8 rx[2] = {0x00, 0x00};

u32 tx_lens[21] = { 4, 4, 6, 4, 4, 4, 4, 4, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6};
u32 rx_lens[21] = { 8,24, 6,24,24, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8};

u8 tx1[8] = {0xa1, 0x00, 0x00, 0x00};
u8 tx2[8] = {0xb0, 0x00, 0x00, 0x00};
u8 tx3[12] = {0xb1, 0x00, 0x01, 0x00, 0x6c, 0x05};
u8 tx4[8] = {0xb0, 0x00, 0x00, 0x00};
u8 tx5[8] = {0xc0, 0x00, 0x00, 0x00};
u8 tx6[8] = {0xc1, 0x00, 0x00, 0x00};
u8 tx7[8] = {0xc2, 0x00, 0x00, 0x00};
u8 tx8[8] = {0xc3, 0x00, 0x00, 0x00};
u8 tx9[12] = {0xc4, 0x00, 0x01, 0x00, 0x0a, 0x00};
u8 tx10[12] = {0xc4, 0x00, 0x01, 0x00, 0x0b, 0x00};
u8 tx11[12] = {0xc4, 0x00, 0x01, 0x00, 0x0c, 0x00};
u8 tx12[12] = {0xc4, 0x00, 0x01, 0x00, 0x0d, 0x00};
u8 tx13[12] = {0xc4, 0x00, 0x01, 0x00, 0x21, 0x00};
u8 tx14[12] = {0xc4, 0x00, 0x01, 0x00, 0x1e, 0x00};
u8 tx15[12] = {0xc4, 0x00, 0x01, 0x00, 0x08, 0x00};
u8 tx16[12] = {0xc4, 0x00, 0x01, 0x00, 0x20, 0x00};
u8 tx17[12] = {0xc4, 0x00, 0x01, 0x00, 0x22, 0x00};
u8 tx18[12] = {0xc4, 0x00, 0x01, 0x00, 0x23, 0x00};
u8 tx19[12] = {0xc4, 0x00, 0x01, 0x00, 0x10, 0x00};
u8 tx20[12] = {0xc4, 0x00, 0x01, 0x00, 0x1c, 0x00};
u8 tx21[12] = {0xc4, 0x00, 0x01, 0x00, 0x1d, 0x00};

u8* cmds[21] = { tx1, tx2, tx3, tx4, tx5, tx6, tx7, tx8, tx9, tx10, tx11, tx12, tx13, tx14, tx15, tx16, tx17, tx18, tx19, tx20, tx21 };

u8 rx1[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx2[48] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx3[12] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx4[48] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx5[48] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx6[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx7[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx8[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx9[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx10[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx11[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx12[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx13[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx14[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx15[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx16[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx17[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx18[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx19[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx20[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
u8 rx21[16] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

u8* resp[21] = { rx1, rx2, rx3, rx4, rx5, rx6, rx7, rx8, rx9, rx10, rx11, rx12, rx13, rx14, rx15, rx16, rx17, rx18, rx19, rx20, rx21 };




// ***************** Available kbus ioctl commands *****************
//
// KBUS_IOC_CONFIG
//
	struct kbus_spi_config {
		__u8		bits_per_word; /* bits_per_word */
		__u8		mode;	       /* see SPI_ mode bits in spi.h */
		__u32		max_speed_hz;
	};
//
//
// KBUS_IOC_CMD
//
	struct kbus_cmd {
		__u8 		*tx_buf;
		__u8 		*rx_buf;
		__u32		byte_len_tx;
		__u32		byte_len_rx;
		__u8 		*err; 	/* will only be set when err occurs! */
		__u8 		*err_state;
		__u32           timeout_ms;
	};
//
//
// KBUS_IOC_DATA
//
	struct kbus_data {
		__u8 		*tx_buf;
		__u8 		*rx_buf;
		__u32		byte_len;
		__u8 		*err; 	/* will only be set when err occurs! */
		__u8 		*err_state;
		__u32           timeout_ms;
	};

#define KBUS_IOC_MAGIC			'K'
#define KBUS_IOC_DATA			_IOW(KBUS_IOC_MAGIC, 1, struct kbus_data)
#define KBUS_IOC_CMD			_IOW(KBUS_IOC_MAGIC, 2, struct kbus_cmd)
#define KBUS_IOC_CONFIG			_IOW(KBUS_IOC_MAGIC, 3, struct kbus_spi_config)


int main() {
	int fd, ret_val, i;
	struct kbus_data kd;
	struct kbus_spi_config ks;
	struct kbus_cmd kc;

	fd = open(DEVICE_FILE_NAME, O_RDWR);
	if (fd < 0) {
		printf ("Can't open device file: %s\n", DEVICE_FILE_NAME);
		return -1;
	}

	// The list of commands and payloads are obtained from Codesys using kbus_dump module

	// Prepare and send first CONFIG command to kbus (for spi config params)
	ks.bits_per_word = 0x10; // 2 bytes commands. With 0x20 use the 4 bytes version of commands
	ks.mode = 0x01;
	ks.max_speed_hz = 0x01312d00;

	ret_val = ioctl(fd, KBUS_IOC_CONFIG, &ks);
	if (ret_val < 0) {
		printf("ioctl CONFIG command failed: %d\n", ret_val);
		close(fd);
		return -1;
	} else {
		printf("ioctl CONFIG command ok\n");
	}

	// Write 0x00000001 to kbus to enable interrupts
	if ((ret_val = write(fd, "\x01\x00\x00\x00", 4)) != 0) {
		printf("kbus write failed: %d\n", ret_val);
		close(fd);
		return -1;
	}

	// Send commands as from codesys kbus dump (need to be reverse-engineered to know the meaning)
	kc.timeout_ms = 5000;
	for (i = 0; i < 21; i++) {
		kc.tx_buf = cmds[i];
		kc.rx_buf = resp[i];
		kc.byte_len_tx = tx_lens[i];
		kc.byte_len_rx = rx_lens[i];
		ret_val = ioctl(fd, KBUS_IOC_CMD, &kc);
		if (ret_val < 0) {
			printf("ioctl CMD command failed: %d\n", ret_val);
			close(fd);
			return -1;
		} else {
			printf("ioctl CMD command ok\n");
		}
	}

	// Send DATA to kbus
	// tx buffer contains the data:
	// 	{0x80, 0x00} switch on the 1st output
	// 	{0x40, 0x00} switch on the 2nd output
	// 	...
	// 	{0x00, 0x00} switch off all outputs
	//
	kd.tx_buf = tx;
	kd.rx_buf = rx;
	kd.byte_len = sizeof(tx);
	kd.timeout_ms = 500;

	for (i = 0; i < 100; i++) {
		ret_val = ioctl(fd, KBUS_IOC_DATA, &kd);
		if (ret_val < 0) {
			printf("ioctl DATA command failed: %d\n", ret_val);
			close(fd);
			return -1;
		} else {
			printf("ioctl DATA command ok\n");
		}
	}

	close(fd); 

	return 0;
}
